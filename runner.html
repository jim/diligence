<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<title>runner</title>
	<script type="text/javascript" charset="utf-8">
       function microAjax(url, callbackFunction)
       {
               this.bindFunction = function (caller, object) {
                       return function() {
                               return caller.apply(object, [object]);
                       };
               };

               this.stateChange = function (object) {
                       if (this.request.readyState==4) {
                           if (req.status == 200) {
                               this.callbackFunction(this.request.responseText);
                           } else {
                               clearInterval(interval);
                           }
                       }
               };

               this.getRequest = function() {
                       if (window.ActiveXObject)
                               return new ActiveXObject('Microsoft.XMLHTTP');
                       else if (window.XMLHttpRequest)
                               return new XMLHttpRequest();
                       return false;
               };

               this.postBody = (arguments[2] || "");

               this.callbackFunction=callbackFunction;
               this.url=url;
               this.request = this.getRequest();

               if(this.request) {
                       var req = this.request;
                       req.onreadystatechange = this.bindFunction(this.stateChange, this);

                       if (this.postBody!=="") {
                               req.open("POST", url, true);
                               req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                               req.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                               req.setRequestHeader('Connection', 'close');
                       } else {
                               req.open("GET", url, true);
                       }

                       req.send(this.postBody);
               }
       }
       
       
       var interval;
       function go() {
           interval = setInterval(run, 1000);
       };
       
       function run() {
          microAjax('/tick', function(response){
              if (response != '') {
                  clearInterval(interval);
                  try {
                      eval(response);
                      microAjax('/result?success=1', function(data) {
                          go();
                      });
                  } catch(exception) {
                      var message = exception.message;
                      microAjax('result?success=0&message=' + message, function(data) {
                         go(); 
                      });
                  }
              }
          });
       };
       
	</script>
</head>
<body onload="run();">
</body>
</html>